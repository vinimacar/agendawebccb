<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agenda de Coletas - CCB</title>

    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/lux/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        .botao-congregacao {
            white-space: normal;
            text-align: left;
        }
        .agendamento-futuro {
            background-color: #e7fbe7;
        }
        .agendado {
            color: green;
        }
    </style>
</head>
<body class="p-3">
    <div class="container">
        <h1 class="mb-4 text-center">AGENDA DE REFORÇOS DE COLETAS</h1>
        <h5 class="mb-4 text-center">Administração de Ituiutaba-MG </h5>
        <h6 class="mb-4 text-center">Referente ao mês de: JUNHO/2025</h6>

        <div class="row row-cols-1 row-cols-md-2 g-2 mb-4" id="congregacoes"></div>

        <div class="table-responsive">
            <h4>Agendamentos</h4>
            <table class="table table-bordered table-striped" id="tabela-agendamentos">
                <thead class="table-dark">
                    <tr>
                        <th>Congregação</th>
                        <th>Data</th>
                        <th>Irmão</th>
                        <th>Tipo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="lista-agendamentos"></tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end">
            <button id="btnExportPDF" class="btn btn-success me-2">Baixar PDF</button>
            <button id="btnExportXLS" class="btn btn-primary me-2">Baixar XLS</button>
            <button id="btnExportPNG" class="btn btn-info">Baixar PNG</button>
        </div>
    </div>

    <div class="modal fade" id="modalAgendamento" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formAgendamento" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agendar Coleta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Congregação</label>
                        <input type="text" class="form-control" id="congregacaoSelecionada" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="dataColeta" class="form-label">Data</label>
                        <input type="date" class="form-control" id="dataColeta" required />
                    </div>
                    <div class="mb-3">
                        <label for="irmaoNome" class="form-label">Nome do Irmão</label>
                        <input type="text" class="form-control" id="irmaoNome" required />
                    </div>
                    <div class="mb-3">
                        <label for="tipoAgendamento" class="form-label">Tipo de Agendamento</label>
                        <select class="form-select" id="tipoAgendamento" required>
                            <option value="">Selecione</option>
                            <option value="Culto Oficial">Culto Oficial</option>
                            <option value="Reunião de Jovens e Menores">Reunião de Jovens e Menores</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

        // IMPORTANTE: A sua API Key e outras configurações do Firebase estão visíveis no código do cliente.
        // Isso é comum para aplicações web que acessam o Firebase Realtime Database diretamente.
        // CERTIFIQUE-SE de que suas REGRAS DE SEGURANÇA do Firebase (Firebase Rules)
        // estão configuradas corretamente no console do Firebase para proteger seus dados contra acesso não autorizado.
        const firebaseConfig = {
            apiKey: "AIzaSyDAZekCEenSVQuYPB2jGqdXc3sllfDqg-M", // Considere usar variáveis de ambiente ou um backend para maior segurança se necessário.
            authDomain: "agendawebccb.firebaseapp.com",
            databaseURL: "https://agendawebccb-default-rtdb.firebaseio.com",
            projectId: "agendawebccb",
            storageBucket: "agendawebccb.firebasestorage.app",
            messagingSenderId: "1002090805726",
            appId: "1:1002090805726:web:d9aab35124d174e85d454f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const congregacoes = [
            "Alvorada", "Buritis", "Capinópolis - Central", "Cachoeira Dourada",
            "Chaveslândia", "Chico Mendes", "Dom Alexandre", "Eldorado",
            "Flor de Minas", "Gurinhatã", "Ipiaçu", "Ipiranga", "Ituiutaba - Central",
            "Jerônimo Mendonça", "Marta Helena", "Natal", "Novo Tempo II",
            "Recanto das Acácias", "Santa Vitória - Central", "Satélite Andradina",
            "Setor Norte"
        ].sort();

        let agendamentos = [];
        let congregacaoAtual = "";
        let indexEdicao = null;

        const modal = new bootstrap.Modal(document.getElementById("modalAgendamento"));

        window.abrirFormulario = function (cong, index = null) {
            congregacaoAtual = cong;
            indexEdicao = index;
            document.getElementById("congregacaoSelecionada").value = cong;
            document.getElementById("dataColeta").value = "";
            document.getElementById("irmaoNome").value = "";
            document.getElementById("tipoAgendamento").value = ""; // Reset do campo

            if (index !== null && agendamentos[index]) { // Adicionada verificação se agendamentos[index] existe
                const ag = agendamentos[index];
                document.getElementById("dataColeta").value = ag.data;
                document.getElementById("irmaoNome").value = ag.irmao;
                document.getElementById("tipoAgendamento").value = ag.tipo; // Carrega o tipo
            }
            modal.show();
        }

        document.getElementById("formAgendamento").addEventListener("submit", async function (e) {
            e.preventDefault();
            const data = document.getElementById("dataColeta").value;
            const irmao = document.getElementById("irmaoNome").value;
            const tipo = document.getElementById("tipoAgendamento").value;
            const hoje = new Date().toISOString().split("T")[0];

            if (!tipo) {
                alert("Por favor, selecione o tipo de agendamento.");
                return;
            }

            if (data < hoje) {
                alert("Não é permitido agendar uma data passada.");
                return;
            }

            const duplicado = agendamentos.some((a, i) => {
                const dataAgendamento = new Date(a.data);
                const dataSelecionada = new Date(data);
                return (
                    a.congregacao === congregacaoAtual &&
                    dataAgendamento.getMonth() === dataSelecionada.getMonth() &&
                    dataAgendamento.getFullYear() === dataSelecionada.getFullYear() &&
                    a.tipo === tipo &&
                    i !== indexEdicao
                );
            });

            if (duplicado) {
                alert(`Já existe um agendamento de "${tipo}" para essa congregação neste mês.`);
                return;
            }

            const novo = { congregacao: congregacaoAtual, data, irmao, tipo };

            try {
                if (indexEdicao !== null && agendamentos[indexEdicao] && agendamentos[indexEdicao].id) {
                    const id = agendamentos[indexEdicao].id;
                    await set(ref(db, "agendamentos/" + id), novo);
                } else {
                    await push(ref(db, "agendamentos"), novo);
                }
                modal.hide();
                mostrarAlerta("Agendamento salvo com sucesso!", "success");
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                mostrarAlerta("Erro ao salvar agendamento. Tente novamente.", "danger");
            }
            // Limpar campos após salvar, mesmo que seja edição, para o próximo agendamento
            document.getElementById("formAgendamento").reset();
            congregacaoAtual = "";
            indexEdicao = null;
        });

        function atualizarTabela() {
            const corpo = document.getElementById("lista-agendamentos");
            corpo.innerHTML = ""; // Para listas grandes, considere usar DocumentFragment para melhor performance.
            const hoje = new Date();

            // Ordenar agendamentos por data antes de exibir
            const agendamentosOrdenados = [...agendamentos].sort((a, b) => new Date(a.data) - new Date(b.data));


            agendamentosOrdenados.forEach((a, index) => { // 'index' aqui não é mais o índice original de 'agendamentos' se ordenado.
                                                        // Para edição/exclusão, precisamos do ID do firebase ou o índice original.
                                                        // Vamos encontrar o índice original para manter a lógica de edição/exclusão.
                const originalIndex = agendamentos.findIndex(item => item.id === a.id);

                const dataObj = new Date(a.data + "T00:00"); // Adicionar T00:00 para evitar problemas de timezone na interpretação da data
                const diaAbreviado = dataObj.toLocaleDateString("pt-BR", { weekday: "short" }).toLowerCase().replace('.', ''); // remove ponto final ex: "sáb." -> "sáb"
                const dataFormatada = dataObj.toLocaleDateString("pt-BR");
                const futura = dataObj >= new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()); // Comparar apenas data

                const linha = `
                    <tr class="${futura ? 'agendamento-futuro' : ''}">
                        <td>${a.congregacao}</td>
                        <td><i class="bi bi-calendar3 me-1"></i>${diaAbreviado} - ${dataFormatada}</td>
                        <td>${a.irmao}</td>
                        <td>${a.tipo}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="abrirFormulario('${a.congregacao}', ${originalIndex})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="excluirAgendamento(${originalIndex})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                corpo.innerHTML += linha;
            });
            atualizarIconesCongregacoes();
        }

        window.excluirAgendamento = async function (index) {
            if (index < 0 || index >= agendamentos.length || !agendamentos[index] || !agendamentos[index].id) {
                console.error("Índice inválido ou agendamento sem ID para exclusão:", index);
                mostrarAlerta("Erro ao tentar excluir: agendamento não encontrado.", "danger");
                return;
            }
            const id = agendamentos[index].id;
            if (confirm("Deseja realmente excluir este agendamento?")) {
                try {
                    await remove(ref(db, "agendamentos/" + id));
                    mostrarAlerta("Agendamento excluído com sucesso!", "info");
                    // A atualização da tabela ocorrerá automaticamente pelo listener 'onValue'
                } catch (error) {
                    console.error("Erro ao excluir agendamento:", error);
                    mostrarAlerta("Erro ao excluir agendamento. Tente novamente.", "danger");
                }
            }
        };

        function carregarAgendamentos() {
            const agRef = ref(db, "agendamentos");
            onValue(agRef, snapshot => {
                const data = snapshot.val();
                agendamentos = []; // Limpa a lista local
                if (data) {
                    for (const key in data) {
                        agendamentos.push({ ...data[key], id: key });
                    }
                }
                // Ordenar agendamentos por data por padrão ao carregar
                agendamentos.sort((a, b) => new Date(a.data) - new Date(b.data));
                atualizarTabela();
                // Não é mais necessário chamar atualizarIconesCongregacoes aqui, pois atualizarTabela já o faz.
            });
        }

        function atualizarIconesCongregacoes() {
            const container = document.getElementById("congregacoes");
            container.innerHTML = "";

            congregacoes.forEach(c => {
                const col = document.createElement("div");
                const botao = document.createElement("button");
                botao.className = "btn btn-outline-primary w-100 botao-congregacao mb-2"; // Adicionado mb-2 para espaçamento

                const agendamentosCongregacao = agendamentos.filter(a => a.congregacao === c);
                const agendamentoCulto = agendamentosCongregacao.some(a => a.tipo === "Culto Oficial");
                const agendamentoJovens = agendamentosCongregacao.some(a => a.tipo === "Reunião de Jovens e Menores");

                let icone = '';
                if (agendamentoCulto && agendamentoJovens) {
                    icone = '<span class="text-success float-end"><i class="bi bi-check-all"></i></span>'; // Alterado para check-all e float-end
                } else if (agendamentoCulto) {
                    icone = '<span class="text-success float-end"><i class="bi bi-check-circle-fill"></i> C</span>'; // Adicionado C para Culto
                } else if (agendamentoJovens) {
                    icone = '<span class="text-success float-end"><i class="bi bi-check-circle-fill"></i> J</span>'; // Adicionado J para Jovens
                }

                botao.innerHTML = `${c} ${icone}`;
                botao.onclick = () => abrirFormulario(c);
                col.appendChild(botao);
                container.appendChild(col);
            });
        }

        function mostrarAlerta(mensagem, tipo) {
            const alerta = document.getElementById("mensagem-alerta");
            const textoAlerta = document.getElementById("texto-alerta");
            // Assegurar que os elementos existem
            if (!alerta || !textoAlerta) {
                console.error("Elementos de alerta não encontrados no DOM.");
                return;
            }
            alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
            textoAlerta.textContent = mensagem;
            alerta.classList.remove("d-none");
            
            // Limpar timeout anterior se houver
            if (alerta.timeoutId) {
                clearTimeout(alerta.timeoutId);
            }

            alerta.timeoutId = setTimeout(() => {
                alerta.classList.add("d-none");
            }, 3000);
        }

        // Adicionar o div para o alerta de feedback ao DOM
        const alertaDiv = document.createElement('div');
        alertaDiv.id = 'mensagem-alerta';
        alertaDiv.className = 'alert alert-dismissible fade show d-none fixed-top m-3'; // Posicionamento melhorado
        alertaDiv.setAttribute('role', 'alert');
        alertaDiv.innerHTML = '<span id="texto-alerta"></span><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>';
        document.querySelector('.container').prepend(alertaDiv);


        carregarAgendamentos();
        atualizarIconesCongregacoes(); // Chamada inicial para desenhar os botões das congregações

        // Exportar como PDF
        document.getElementById("btnExportPDF").addEventListener("click", async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Agenda de Coletas - CCB", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });
            doc.setFontSize(10);
            doc.text(`Mês de Referência: JUNHO/2025`, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });
            doc.setFontSize(12);

            let y = 35;
            const agendamentosOrdenados = [...agendamentos].sort((a, b) => new Date(a.data) - new Date(b.data));


            agendamentosOrdenados.forEach((a, index) => {
                const dataObj = new Date(a.data + "T00:00");
                const diaAbrev = dataObj.toLocaleDateString("pt-BR", { weekday: "short" }).toLowerCase().replace('.','');
                const dataFormatada = dataObj.toLocaleDateString("pt-BR");

                // CORREÇÃO: Removidas tags HTML da linha de texto do PDF
                const linha = `${index + 1}. ${a.congregacao} - ${diaAbrev} - ${dataFormatada} - ${a.irmao} (${a.tipo})`;
                
                if (y > 270) { // Checagem de quebra de página
                    doc.addPage();
                    y = 15; // Reinicia y na nova página
                     doc.setFontSize(18);
                    doc.text("Agenda de Coletas - CCB", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });
                    doc.setFontSize(12);
                    y = 25;
                }
                doc.text(linha, 10, y);
                y += 7;
            });

            doc.save("agendamentos_ccb.pdf");
        });

        // Exportar como XLS
        document.getElementById("btnExportXLS").addEventListener("click", () => {
            const agendamentosOrdenados = [...agendamentos].sort((a, b) => new Date(a.data) - new Date(b.data));

            const dados = agendamentosOrdenados.map(a => {
                const dataObj = new Date(a.data + "T00:00");
                const diaAbrev = dataObj.toLocaleDateString("pt-BR", { weekday: "short" }).toLowerCase().replace('.','');
                const dataFormatada = dataObj.toLocaleDateString("pt-BR");

                return {
                    Congregação: a.congregacao,
                    Data: `${diaAbrev} - ${dataFormatada}`,
                    Irmão: a.irmao,
                    Tipo: a.tipo
                };
            });

            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");
            XLSX.writeFile(wb, "agendamentos_ccb.xlsx");
        });

        // Exportar como PNG
        document.getElementById("btnExportPNG").addEventListener("click", () => {
            const tabelaElement = document.getElementById("tabela-agendamentos");
            const congregacoesElement = document.getElementById("congregacoes");
            const tituloPrincipal = document.querySelector(".container > h1");
            const subtituloAdmin = document.querySelector(".container > h5");
            const subtituloMes = document.querySelector(".container > h6");
            
            // Criar um contêiner temporário para a imagem
            const containerParaImagem = document.createElement('div');
            containerParaImagem.style.padding = '20px';
            containerParaImagem.style.backgroundColor = 'white'; // Fundo branco para a imagem
            
            // Clonar e adicionar os elementos desejados
            if(tituloPrincipal) containerParaImagem.appendChild(tituloPrincipal.cloneNode(true));
            if(subtituloAdmin) containerParaImagem.appendChild(subtituloAdmin.cloneNode(true));
            if(subtituloMes) containerParaImagem.appendChild(subtituloMes.cloneNode(true));
            if(congregacoesElement) containerParaImagem.appendChild(congregacoesElement.cloneNode(true)); // Adiciona botões
            containerParaImagem.appendChild(document.createElement('hr')); // Linha separadora
            if(tabelaElement) containerParaImagem.appendChild(tabelaElement.cloneNode(true));

            // Adicionar temporariamente ao corpo para renderização correta
            document.body.appendChild(containerParaImagem);

            html2canvas(containerParaImagem, { scale: 2 }).then(canvas => { // Aumenta a escala para melhor qualidade
                const link = document.createElement("a");
                link.download = "agendamentos_ccb.png";
                link.href = canvas.toDataURL("image/png");
                link.click();
                document.body.removeChild(containerParaImagem); // Remover o contêiner temporário
            }).catch(err => {
                console.error("Erro ao gerar PNG:", err);
                document.body.removeChild(containerParaImagem); // Remover em caso de erro também
            });
        });
    </script>
    </body>
</html>
