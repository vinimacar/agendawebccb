<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agenda de Serviços - CCB</title>

    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/lux/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #3949ab;
            --success-color: #2e7d32;
            --warning-color: #f57f17;
            --danger-color: #c62828;
            --info-color: #0277bd;
            --light-bg: #f5f6fa;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Inter', sans-serif;
            padding-bottom: 80px;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .service-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            border: none;
            height: 100%;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .service-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-bg);
        }

        .service-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .service-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--light-bg);
            color: var(--primary-color);
        }

        .service-count {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .calendar-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .filters-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 0 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-buttons {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
            z-index: 1000;
        }

        .action-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
        }

        .action-button:hover {
            transform: scale(1.1);
        }

        .modal-content {
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }

        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="container">
            <h1 class="app-title text-center">AGENDA DE SERVIÇOS</h1>
            <p class="text-center mb-4">Administração de Ituiutaba-MG</p>
            
            <div class="filters-container">
                <div class="input-group" style="max-width: 200px;">
                    <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                    <select class="form-select" id="monthSelector">
                        <option value="6">Junho/2025</option>
                        <option value="7">Julho/2025</option>
                        <option value="8">Agosto/2025</option>
                    </select>
                </div>
                
                <div class="input-group" style="max-width: 200px;">
                    <span class="input-group-text"><i class="bi bi-funnel"></i></span>
                    <select class="form-select" id="tipoFiltro">
                        <option value="">Todos os Tipos</option>
                        <option value="BATISMOS">Batismos</option>
                        <option value="SANTAS-CEIAS">Santas Ceias</option>
                        <option value="REUNIÃO PARA MOCIDADE">Reunião para Mocidade</option>
                        <option value="ENSAIOS REGIONAIS">Ensaios Regionais</option>
                        <option value="ENSAIOS LOCAIS">Ensaios Locais</option>
                        <option value="REUNIÃO DE CONSELHO DA MOCIDADE">Reunião de Conselho</option>
                        <option value="REUNIÃO DA OBRA DA PIEDADE">Reunião da Piedade</option>
                        <option value="EVANGELIZAÇÃO">Evangelização</option>
                    </select>
                </div>

                <button class="btn btn-outline-light" onclick="toggleView()">
                    <i class="bi bi-grid-3x3-gap"></i>
                    Alternar Visualização
                </button>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <!-- Visualização de Calendário -->
        <div id="calendarView" class="calendar-container" style="display: none;">
            <div id="calendar"></div>
        </div>

        <!-- Visualização em Cards -->
        <div id="cardsView" class="dashboard-container">
            <!-- Batismos -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-water"></i>
                        </div>
                        <span>Batismos</span>
                    </div>
                    <span class="service-count badge bg-primary" id="batismos-count">0</span>
                </div>
                <div id="batismos-list" class="service-list"></div>
            </div>

            <!-- Santas Ceias -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-cup-hot"></i>
                        </div>
                        <span>Santas Ceias</span>
                    </div>
                    <span class="service-count badge bg-danger" id="santas-ceias-count">0</span>
                </div>
                <div id="santas-ceias-list" class="service-list"></div>
            </div>

            <!-- Reunião para Mocidade -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <span>Reunião para Mocidade</span>
                    </div>
                    <span class="service-count badge bg-success" id="mocidade-count">0</span>
                </div>
                <div id="mocidade-list" class="service-list"></div>
            </div>

            <!-- Ensaios Regionais -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-music-note-list"></i>
                        </div>
                        <span>Ensaios Regionais</span>
                    </div>
                    <span class="service-count badge bg-warning" id="ensaios-regionais-count">0</span>
                </div>
                <div id="ensaios-regionais-list" class="service-list"></div>
            </div>

            <!-- Ensaios Locais -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-music-note"></i>
                        </div>
                        <span>Ensaios Locais</span>
                    </div>
                    <span class="service-count badge bg-info" id="ensaios-locais-count">0</span>
                </div>
                <div id="ensaios-locais-list" class="service-list"></div>
            </div>

            <!-- Reunião de Conselho -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <span>Reunião de Conselho</span>
                    </div>
                    <span class="service-count badge bg-primary" id="conselho-mocidade-count">0</span>
                </div>
                <div id="conselho-mocidade-list" class="service-list"></div>
            </div>

            <!-- Reunião da Piedade -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-heart-fill"></i>
                        </div>
                        <span>Reunião da Piedade</span>
                    </div>
                    <span class="service-count badge bg-danger" id="obra-piedade-count">0</span>
                </div>
                <div id="obra-piedade-list" class="service-list"></div>
            </div>

            <!-- Evangelização -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-megaphone"></i>
                        </div>
                        <span>Evangelização</span>
                    </div>
                    <span class="service-count badge bg-success" id="evangelizacao-count">0</span>
                </div>
                <div id="evangelizacao-list" class="service-list"></div>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="action-buttons">
        <button class="action-button btn btn-info" onclick="exportarTodosServicos()" data-bs-toggle="tooltip" data-bs-placement="left" title="Exportar Relatório">
            <i class="bi bi-file-earmark-pdf"></i>
        </button>
        <button class="action-button btn btn-success" onclick="abrirModalCadastro()" data-bs-toggle="tooltip" data-bs-placement="left" title="Agendar Novo Serviço">
            <i class="bi bi-plus-lg"></i>
        </button>
        <a href="index.html" class="action-button btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="left" title="Voltar">
            <i class="bi bi-arrow-left"></i>
        </a>
    </div>

    <!-- Modal de Cadastro de Serviço -->
    <div class="modal fade" id="modalServico" tabindex="-1" aria-labelledby="modalServicoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalServicoLabel">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Agendar Serviço
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form id="formServico" class="needs-validation" novalidate>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="tipoServico" class="form-label">Tipo de Serviço</label>
                            <select class="form-select" id="tipoServico" required onchange="toggleCamposAdicionais()">
                                <option value="">Selecione o tipo de serviço</option>
                                <option value="BATISMOS">Batismos</option>
                                <option value="SANTAS-CEIAS">Santas Ceias</option>
                                <option value="REUNIÃO PARA MOCIDADE">Reunião para Mocidade</option>
                                <option value="ENSAIOS REGIONAIS">Ensaios Regionais</option>
                                <option value="ENSAIOS LOCAIS">Ensaios Locais</option>
                                <option value="REUNIÃO DE CONSELHO DA MOCIDADE">Reunião de Conselho da Mocidade</option>
                                <option value="REUNIÃO DA OBRA DA PIEDADE">Reunião da Obra da Piedade</option>
                                <option value="EVANGELIZAÇÃO">Evangelização</option>
                            </select>
                            <div class="invalid-feedback">
                                Por favor, selecione o tipo de serviço.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="dataServico" class="form-label">Data</label>
                            <input type="date" class="form-control" id="dataServico" required>
                            <div class="invalid-feedback">
                                Por favor, selecione a data do serviço.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="localServico" class="form-label">Local</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="localServico" 
                                    placeholder="Selecione a congregação"
                                    required
                                    list="localidadesList"
                                    autocomplete="off">
                                <button class="btn btn-outline-primary" type="button" onclick="abrirModalLocalidades()"
                                    data-bs-toggle="tooltip" data-bs-placement="top" title="Buscar congregação">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <datalist id="localidadesList"></datalist>
                            <div class="invalid-feedback">
                                Por favor, selecione uma congregação.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="irmaoAtendente" class="form-label">Irmão que Atende</label>
                            <input type="text" class="form-control" id="irmaoAtendente" 
                                placeholder="Nome do irmão que atende" required>
                            <div class="invalid-feedback">
                                Por favor, informe o irmão que atende.
                            </div>
                        </div>

                        <!-- Campos específicos para Ensaios Regionais -->
                        <div id="camposEnsaiosRegionais" style="display: none;">
                            <div class="mb-3">
                                <label for="encarregadoRegional" class="form-label">Encarregado Regional</label>
                                <input type="text" class="form-control" id="encarregadoRegional" 
                                    placeholder="Nome do encarregado regional">
                                <div class="invalid-feedback">
                                    Por favor, informe o encarregado regional.
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="observacoesServico" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoesServico" rows="3" 
                                placeholder="Observações adicionais (opcional)"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Serviço -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesTitulo"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div id="detalhesConteudo"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="exportarRelatorio()">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Exportar Relatório
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Localidades -->
    <div class="modal fade" id="modalLocalidades" tabindex="-1" aria-labelledby="modalLocalidadesLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLocalidadesLabel">
                        <i class="bi bi-building me-2"></i>
                        Selecionar Congregação
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="buscaLocalidade" 
                            placeholder="Buscar por nome ou número"
                            oninput="filtrarLocalidades(this.value)">
                    </div>
                    <div id="listaLocalidades" class="list-group">
                        <!-- Será preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, serverTimestamp, remove, get } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAZekCEenSVQuYPB2jGqdXc3sllfDqg-M",
            authDomain: "agendawebccb.firebaseapp.com",
            databaseURL: "https://agendawebccb-default-rtdb.firebaseio.com",
            projectId: "agendawebccb",
            storageBucket: "agendawebccb.firebasestorage.app",
            messagingSenderId: "1002090805726",
            appId: "1:1002090805726:web:d9aab35124d174e85d454f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Exportar funções necessárias para o escopo global
        window.db = db;
        window.ref = ref;
        window.push = push;
        window.set = set;
        window.remove = remove;
        window.get = get;
        window.serverTimestamp = serverTimestamp;

        // Inicializar modais globalmente
        window.modalServico = null;
        window.modalDetalhes = null;

        // Função para formatar a data
        window.formatarData = function(data) {
            const dataObj = new Date(data);
            return dataObj.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Função para abrir modal de cadastro
        window.abrirModalCadastro = function() {
            if (!window.modalServico) {
                window.modalServico = new bootstrap.Modal(document.getElementById('modalServico'));
            }
            document.getElementById('formServico').reset();
            document.getElementById('formServico').dataset.editId = '';
            window.modalServico.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar modais
            window.modalServico = new bootstrap.Modal(document.getElementById('modalServico'));
            window.modalDetalhes = new bootstrap.Modal(document.getElementById('modalDetalhes'));

            // Inicializar calendário
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                eventClick: function(info) {
                    mostrarDetalhesServico(info.event.extendedProps.tipo);
                },
                events: []
            });
            calendar.render();
            
            // Inicializar tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Carregar serviços iniciais
            carregarServicos();

            // Adicionar listeners
            document.getElementById('monthSelector').addEventListener('change', carregarServicos);
            document.getElementById('tipoFiltro').addEventListener('change', filtrarServicos);

            // Listener para o formulário de serviço
            document.getElementById('formServico').addEventListener('submit', async function(e) {
                e.preventDefault();
                const editId = this.dataset.editId;
                
                try {
                    const servico = {
                        tipo: document.getElementById('tipoServico').value,
                        data: document.getElementById('dataServico').value,
                        local: document.getElementById('localServico').value,
                        irmaoAtendente: document.getElementById('irmaoAtendente').value,
                        observacoes: document.getElementById('observacoesServico').value,
                        ultimaAtualizacao: serverTimestamp()
                    };

                    if (servico.tipo === 'ENSAIOS REGIONAIS') {
                        servico.encarregadoRegional = document.getElementById('encarregadoRegional').value;
                    }

                    if (editId) {
                        const servicoRef = ref(db, `agendamento2/${editId}`);
                        await set(servicoRef, servico);
                        mostrarToast('Serviço atualizado com sucesso!', 'success');
                    } else {
                        servico.dataCadastro = serverTimestamp();
                        const servicosRef = ref(db, 'agendamento2');
                        await push(servicosRef, servico);
                        mostrarToast('Serviço cadastrado com sucesso!', 'success');
                    }

                    window.modalServico.hide();
                    this.reset();
                    this.dataset.editId = '';
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    mostrarToast('Erro ao salvar serviço: ' + error.message, 'danger');
                }
            });
        });

        // Função para alternar entre visualizações
        window.toggleView = function() {
            const calendarView = document.getElementById('calendarView');
            const cardsView = document.getElementById('cardsView');
            
            if (calendarView.style.display === 'none') {
                calendarView.style.display = 'block';
                cardsView.style.display = 'none';
                calendar.render();
            } else {
                calendarView.style.display = 'none';
                cardsView.style.display = 'grid';
            }
        }

        // Função para filtrar serviços
        function filtrarServicos() {
            const tipo = document.getElementById('tipoFiltro').value;
            const cards = document.querySelectorAll('.service-card');
            
            if (!tipo) {
                cards.forEach(card => card.style.display = 'block');
                return;
            }

            cards.forEach(card => {
                const cardTipo = card.querySelector('.service-title span').textContent;
                card.style.display = cardTipo.toUpperCase() === tipo ? 'block' : 'none';
            });
        }

        // Função para carregar serviços
        window.carregarServicos = function() {
            const servicosRef = ref(db, 'agendamento2');
            onValue(servicosRef, (snapshot) => {
                const servicos = snapshot.val() || {};
                
                // Limpar todas as listas e contadores
                document.querySelectorAll('.service-list').forEach(el => el.innerHTML = '');
                document.querySelectorAll('[id$="-count"]').forEach(el => el.textContent = '0');

                // Limpar eventos do calendário
                calendar.removeAllEvents();
                
                // Filtrar por mês selecionado
                const mesSelecionado = document.getElementById('monthSelector').value;
                
                Object.entries(servicos).forEach(([id, servico]) => {
                    servico.id = id;
                    const servicoData = new Date(servico.data);
                    
                    if (servicoData.getMonth() + 1 === parseInt(mesSelecionado)) {
                        // Adicionar ao card correspondente
                        const elementId = servico.tipo.toLowerCase().replace(/\s+/g, '-') + '-list';
                        const countId = elementId.replace('-list', '-count');
                        const element = document.getElementById(elementId);
                        const countElement = document.getElementById(countId);
                        
                        if (element) {
                            element.innerHTML += criarItemServico(servico);
                            if (countElement) {
                                countElement.textContent = parseInt(countElement.textContent) + 1;
                            }
                        }

                        // Adicionar ao calendário
                        calendar.addEvent({
                            title: servico.tipo,
                            start: servico.data,
                            backgroundColor: getEventColor(servico.tipo),
                            extendedProps: {
                                tipo: servico.tipo,
                                local: servico.local,
                                status: servico.status
                            }
                        });
                    }
                });

                calendar.render();
            });
        }

        // Função para obter cor do evento baseado no tipo
        function getEventColor(tipo) {
            const cores = {
                'BATISMOS': '#1a237e',
                'SANTAS-CEIAS': '#c62828',
                'REUNIÃO PARA MOCIDADE': '#2e7d32',
                'ENSAIOS REGIONAIS': '#f57f17',
                'ENSAIOS LOCAIS': '#0277bd',
                'REUNIÃO DE CONSELHO DA MOCIDADE': '#283593',
                'REUNIÃO DA OBRA DA PIEDADE': '#ad1457',
                'EVANGELIZAÇÃO': '#00695c'
            };
            return cores[tipo] || '#666666';
        }

        // Função para criar um item de serviço
        window.criarItemServico = function(servico) {
            let infoAdicional = '';
            if (servico.tipo === 'ENSAIOS REGIONAIS') {
                infoAdicional = `
                    <div class="mt-2">
                        ${servico.encarregadoRegional ? `<div><i class="bi bi-person-badge me-2"></i>Encarregado Regional: ${servico.encarregadoRegional}</div>` : ''}
                    </div>
                `;
            }

            return `
                <div class="service-item p-3 mb-3 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="mb-2">
                                <i class="bi bi-calendar3 me-2"></i>
                                <strong>${formatarData(servico.data)}</strong>
                            </div>
                            <div class="mb-2">
                                <i class="bi bi-geo-alt me-2"></i>
                                ${servico.local}
                            </div>
                            <div class="mb-2">
                                <i class="bi bi-person me-2"></i>
                                Irmão que atende: ${servico.irmaoAtendente}
                            </div>
                            ${infoAdicional}
                            ${servico.observacoes ? `
                            <div class="mt-2 text-muted">
                                <i class="bi bi-chat-text me-2"></i>
                                ${servico.observacoes}
                            </div>
                            ` : ''}
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editarServico('${servico.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirServico('${servico.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Função para salvar serviço
        window.salvarServico = async function() {
            const tipo = document.getElementById('tipoServico').value;
            const data = document.getElementById('dataServico').value;
            const local = document.getElementById('localServico').value;
            const status = document.getElementById('statusServico').value;
            const observacoes = document.getElementById('observacoesServico').value;

            if (!tipo || !data || !local || !status) {
                mostrarToast('Preencha todos os campos obrigatórios', 'danger');
                return;
            }

            try {
                const servicosRef = ref(db, 'agendamento2');
                const novoServico = {
                    tipo,
                    data,
                    local,
                    status,
                    observacoes,
                    dataCadastro: serverTimestamp(),
                    ultimaAtualizacao: serverTimestamp()
                };

                await push(servicosRef, novoServico);
                modalServico.hide();
                mostrarToast('Serviço cadastrado com sucesso!', 'success');
                document.getElementById('formServico').reset();
            } catch (error) {
                console.error('Erro ao salvar:', error);
                mostrarToast('Erro ao cadastrar serviço: ' + error.message, 'danger');
            }
        }

        // Função para editar serviço
        window.editarServico = async function(id) {
            const servicoRef = ref(db, `agendamento2/${id}`);
            
            try {
                const snapshot = await get(servicoRef);
                const servico = snapshot.val();
                
                if (servico) {
                    document.getElementById('tipoServico').value = servico.tipo;
                    document.getElementById('dataServico').value = servico.data;
                    document.getElementById('localServico').value = servico.local;
                    document.getElementById('irmaoAtendente').value = servico.irmaoAtendente || '';
                    document.getElementById('observacoesServico').value = servico.observacoes || '';

                    toggleCamposAdicionais();
                    if (servico.tipo === 'ENSAIOS REGIONAIS') {
                        document.getElementById('encarregadoRegional').value = servico.encarregadoRegional || '';
                    }
                    
                    document.getElementById('formServico').dataset.editId = id;
                    window.modalServico.show();
                }
            } catch (error) {
                console.error('Erro ao carregar serviço:', error);
                mostrarToast('Erro ao carregar serviço: ' + error.message, 'danger');
            }
        }

        // Função para excluir serviço
        window.excluirServico = async function(id) {
            if (confirm('Tem certeza que deseja excluir este serviço?')) {
                try {
                    const servicoRef = ref(db, `agendamento2/${id}`);
                    await remove(servicoRef);
                    mostrarToast('Serviço excluído com sucesso!', 'success');
                } catch (error) {
                    console.error('Erro ao excluir:', error);
                    mostrarToast('Erro ao excluir serviço: ' + error.message, 'danger');
                }
            }
        }

        function mostrarDetalhesServico(tipo) {
            if (!window.modalDetalhes) {
                window.modalDetalhes = new bootstrap.Modal(document.getElementById('modalDetalhes'));
            }
            const titulo = document.getElementById('detalhesTitulo');
            const conteudo = document.getElementById('detalhesConteudo');
            
            titulo.innerHTML = `<i class="bi bi-info-circle me-2"></i>${tipo}`;
            const lista = document.getElementById(`${tipo.toLowerCase().replace(/\s+/g, '-')}-list`).innerHTML;
            
            if (lista.trim()) {
                conteudo.innerHTML = lista;
            } else {
                conteudo.innerHTML = '<div class="alert alert-info">Nenhum serviço cadastrado para este tipo.</div>';
            }
            
            window.modalDetalhes.show();
        }

        function mostrarToast(mensagem, tipo) {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${tipo} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-info-circle me-2"></i>${mensagem}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function exportarRelatorio() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const titulo = document.getElementById('detalhesTitulo').textContent;
            const conteudo = document.getElementById('detalhesConteudo').textContent;
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text(titulo, 20, 20);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            
            const linhas = doc.splitTextToSize(conteudo, 170);
            doc.text(linhas, 20, 40);
            
            doc.save(`relatorio_${titulo.toLowerCase().replace(/\s+/g, '_')}.pdf`);
        }

        function exportarTodosServicos() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("Relatório Completo de Serviços", 105, 20, { align: "center" });
            
            let yPos = 40;
            
            document.querySelectorAll('.service-card').forEach(card => {
                const titulo = card.querySelector('.service-title').textContent.trim();
                const conteudo = card.querySelector(`[id$="-list"]`).textContent.trim();
                
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.text(titulo, 20, yPos);
                yPos += 10;
                
                if (conteudo) {
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(12);
                    const linhas = doc.splitTextToSize(conteudo, 170);
                    doc.text(linhas, 20, yPos);
                    yPos += linhas.length * 7 + 10;
                } else {
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(12);
                    doc.text("Nenhum serviço cadastrado", 20, yPos);
                    yPos += 20;
                }
            });
            
            doc.save("relatorio_completo_servicos.pdf");
        }

        // Função para mostrar/ocultar campos adicionais baseado no tipo de serviço
        function toggleCamposAdicionais() {
            const tipoServico = document.getElementById('tipoServico').value;
            const camposEnsaiosRegionais = document.getElementById('camposEnsaiosRegionais');
            const irmaoAtendente = document.getElementById('irmaoAtendente');
            const encarregadoRegional = document.getElementById('encarregadoRegional');

            if (tipoServico === 'ENSAIOS REGIONAIS') {
                camposEnsaiosRegionais.style.display = 'block';
                irmaoAtendente.required = true;
                encarregadoRegional.required = true;
            } else {
                camposEnsaiosRegionais.style.display = 'none';
                irmaoAtendente.required = false;
                encarregadoRegional.required = false;
            }
        }

        // Variável global para armazenar as localidades
        let localidades = [];
        let modalLocalidades = null;

        // Função para carregar localidades do index.html
        async function carregarLocalidades() {
            try {
                const response = await fetch('index.html');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Encontrar todas as congregações no index.html
                // Buscando especificamente os elementos com a classe 'congregacao'
                const elementos = doc.querySelectorAll('.congregacao');
                localidades = Array.from(elementos).map(el => {
                    // Extrair o nome da congregação e o número
                    const nome = el.querySelector('.nome-congregacao')?.textContent || '';
                    const numero = el.querySelector('.numero-congregacao')?.textContent || '';
                    return {
                        nome: nome.trim(),
                        numero: numero.trim(),
                        texto: `${nome.trim()} - ${numero.trim()}`
                    };
                }).filter(loc => loc.nome && loc.numero); // Filtrar entradas vazias
                
                // Ordenar por nome
                localidades.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Preencher o datalist
                const datalist = document.getElementById('localidadesList');
                datalist.innerHTML = localidades.map(local => 
                    `<option value="${local.texto}">${local.nome} - ${local.numero}</option>`
                ).join('');
                
                // Preencher a lista inicial no modal
                atualizarListaLocalidades(localidades);
            } catch (error) {
                console.error('Erro ao carregar localidades:', error);
                mostrarToast('Erro ao carregar lista de congregações', 'danger');
            }
        }

        // Função para filtrar localidades
        function filtrarLocalidades(termo) {
            const termoLower = termo.toLowerCase();
            const localidadesFiltradas = localidades.filter(local => 
                local.nome.toLowerCase().includes(termoLower) ||
                local.numero.toLowerCase().includes(termoLower)
            );
            atualizarListaLocalidades(localidadesFiltradas);
        }

        // Função para atualizar a lista de localidades no modal
        function atualizarListaLocalidades(lista) {
            const listaEl = document.getElementById('listaLocalidades');
            listaEl.innerHTML = lista.map(local => `
                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="selecionarLocalidade('${local.texto}')">
                    <div>
                        <i class="bi bi-building me-2"></i>
                        <span class="fw-medium">${local.nome}</span>
                    </div>
                    <span class="badge bg-primary rounded-pill">${local.numero}</span>
                </button>
            `).join('') || '<div class="text-center p-3 text-muted">Nenhuma congregação encontrada</div>';
        }

        // Função para abrir modal de localidades
        function abrirModalLocalidades() {
            if (!modalLocalidades) {
                inicializarModalLocalidades();
            }
            // Limpar campo de busca
            document.getElementById('buscaLocalidade').value = '';
            // Mostrar todas as localidades
            atualizarListaLocalidades(localidades);
            modalLocalidades.show();
        }

        // Função para selecionar localidade
        function selecionarLocalidade(texto) {
            document.getElementById('localServico').value = texto;
            modalLocalidades.hide();
        }

        // Atualizar o modal de localidades
        const modalLocalidadesHtml = `
            <div class="modal fade" id="modalLocalidades" tabindex="-1" aria-labelledby="modalLocalidadesLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLocalidadesLabel">
                                <i class="bi bi-building me-2"></i>
                                Selecionar Congregação
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="input-group mb-3">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="buscaLocalidade" 
                                    placeholder="Buscar por nome ou número"
                                    oninput="filtrarLocalidades(this.value)">
                            </div>
                            <div id="listaLocalidades" class="list-group">
                                <!-- Será preenchido via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Função para inicializar o modal de localidades
        function inicializarModalLocalidades() {
            // Remover modal existente se houver
            const modalExistente = document.getElementById('modalLocalidades');
            if (modalExistente) {
                modalExistente.remove();
            }

            // Adicionar novo modal ao documento
            document.body.insertAdjacentHTML('beforeend', modalLocalidadesHtml);
            
            // Inicializar o modal do Bootstrap
            modalLocalidades = new bootstrap.Modal(document.getElementById('modalLocalidades'));
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 
