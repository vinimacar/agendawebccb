<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agenda de Serviços - CCB</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDAZekCEenSVQuYPB2jGqdXc3sllfDqg-M",
            authDomain: "agendawebccb.firebaseapp.com",
            databaseURL: "https://agendawebccb-default-rtdb.firebaseio.com",
            projectId: "agendawebccb",
            storageBucket: "agendawebccb.appspot.com",
            messagingSenderId: "1027981883218",
            appId: "1:1027981883218:web:23c0fe509f755f1e0d4805"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Database References
        const servicesRef = database.ref('services');
        const congregationsRef = database.ref('congregations');

        // Service Types
        const SERVICE_TYPES = {
            BATISMOS: {
                name: 'Batismos',
                icon: 'bi-water',
                color: 'primary'
            },
            SANTAS_CEIAS: {
                name: 'Santas Ceias',
                icon: 'bi-cup-hot',
                color: 'danger'
            },
            REUNIAO_MOCIDADE: {
                name: 'Reunião para Mocidade',
                icon: 'bi-people',
                color: 'success'
            },
            ENSAIOS_REGIONAIS: {
                name: 'Ensaios Regionais',
                icon: 'bi-music-note-beamed',
                color: 'info'
            },
            ENSAIOS_LOCAIS: {
                name: 'Ensaios Locais',
                icon: 'bi-music-note',
                color: 'secondary'
            },
            REUNIAO_CONSELHO: {
                name: 'Reunião de Conselho',
                icon: 'bi-clipboard-data',
                color: 'warning'
            },
            OBRA_PIEDADE: {
                name: 'Reunião da Piedade',
                icon: 'bi-heart',
                color: 'danger'
            },
            EVANGELIZACAO: {
                name: 'Evangelização',
                icon: 'bi-book',
                color: 'success'
            }
        };

        // Get services by date range
        function getServicesByDateRange(startDate, endDate) {
            return servicesRef
                .orderByChild('date')
                .startAt(startDate)
                .endAt(endDate)
                .once('value');
        }

        // Create new service
        function createService(serviceData) {
            const newServiceRef = servicesRef.push();
            return newServiceRef.set({
                ...serviceData,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Update existing service
        function updateService(serviceId, serviceData) {
            return servicesRef.child(serviceId).update({
                ...serviceData,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Delete service
        function deleteService(serviceId) {
            return servicesRef.child(serviceId).remove();
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/lux/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #3949ab;
            --success-color: #2e7d32;
            --warning-color: #f57f17;
            --danger-color: #c62828;
            --info-color: #0277bd;
            --light-bg: #f5f6fa;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Inter', sans-serif;
            padding-bottom: 80px;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .service-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            border: none;
            height: 100%;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .service-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-bg);
        }

        .service-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .service-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--light-bg);
            color: var(--primary-color);
        }

        .service-count {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .calendar-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .filters-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 0 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-buttons {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
            z-index: 1000;
        }

        .action-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
        }

        .action-button:hover {
            transform: scale(1.1);
        }

        .modal-content {
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }

        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="container">
            <h1 class="app-title text-center">AGENDA DE SERVIÇOS</h1>
            <p class="text-center mb-4">Administração de Ituiutaba-MG</p>
            
            <div class="filters-container">
                <div class="input-group" style="max-width: 200px;">
                    <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                    <select class="form-select" id="monthSelector">
                        <option value="6">Junho/2025</option>
                        <option value="7">Julho/2025</option>
                        <option value="8">Agosto/2025</option>
                    </select>
                </div>
                
                <div class="input-group" style="max-width: 200px;">
                    <span class="input-group-text"><i class="bi bi-funnel"></i></span>
                    <select class="form-select" id="tipoFiltro">
                        <option value="">Todos os Tipos</option>
                        <option value="BATISMOS">Batismos</option>
                        <option value="SANTAS-CEIAS">Santas Ceias</option>
                        <option value="REUNIÃO PARA MOCIDADE">Reunião para Mocidade</option>
                        <option value="ENSAIOS REGIONAIS">Ensaios Regionais</option>
                        <option value="ENSAIOS LOCAIS">Ensaios Locais</option>
                        <option value="REUNIÃO DE CONSELHO DA MOCIDADE">Reunião de Conselho</option>
                        <option value="REUNIÃO DA OBRA DA PIEDADE">Reunião da Piedade</option>
                        <option value="EVANGELIZAÇÃO">Evangelização</option>
                    </select>
                </div>

                <button class="btn btn-outline-light" onclick="toggleView()">
                    <i class="bi bi-grid-3x3-gap"></i>
                    Alternar Visualização
                </button>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <!-- Visualização de Calendário -->
        <div id="calendarView" class="calendar-container" style="display: none;">
            <div id="calendar"></div>
        </div>

        <!-- Visualização em Cards -->
        <div id="cardsView" class="dashboard-container">
            <!-- Batismos -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-water"></i>
                        </div>
                        <span>Batismos</span>
                    </div>
                    <span class="service-count badge bg-primary" id="batismos-count">0</span>
                </div>
                <div id="batismos-list" class="service-list"></div>
            </div>

            <!-- Santas Ceias -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-cup-hot"></i>
                        </div>
                        <span>Santas Ceias</span>
                    </div>
                    <span class="service-count badge bg-danger" id="santas_ceias-list-count">0</span>
                </div>
                <div id="santas_ceias-list" class="service-list"></div>
            </div>

            <!-- Reunião para Mocidade -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <span>Reunião para Mocidade</span>
                    </div>
                    <span class="service-count badge bg-success" id="reuniao_mocidade-list-count">0</span>
                </div>
                <div id="reuniao_mocidade-list" class="service-list"></div>
            </div>

            <!-- Ensaios Regionais -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-music-note-list"></i>
                        </div>
                        <span>Ensaios Regionais</span>
                    </div>
                    <span class="service-count badge bg-warning" id="ensaios_regionais-list-count">0</span>
                </div>
                <div id="ensaios_regionais-list" class="service-list"></div>
            </div>

            <!-- Ensaios Locais -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-music-note"></i>
                        </div>
                        <span>Ensaios Locais</span>
                    </div>
                    <span class="service-count badge bg-info" id="ensaios_locais-list-count">0</span>
                </div>
                <div id="ensaios_locais-list" class="service-list"></div>
            </div>

            <!-- Reunião de Conselho -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <span>Reunião de Conselho</span>
                    </div>
                    <span class="service-count badge bg-primary" id="reuniao_conselho-list-count">0</span>
                </div>
                <div id="reuniao_conselho-list" class="service-list"></div>
            </div>

            <!-- Reunião da Piedade -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-heart-fill"></i>
                        </div>
                        <span>Reunião da Piedade</span>
                    </div>
                    <span class="service-count badge bg-danger" id="obra_piedade-list-count">0</span>
                </div>
                <div id="obra_piedade-list" class="service-list"></div>
            </div>

            <!-- Evangelização -->
            <div class="service-card">
                <div class="service-header">
                    <div class="service-title">
                        <div class="service-icon">
                            <i class="bi bi-megaphone"></i>
                        </div>
                        <span>Evangelização</span>
                    </div>
                    <span class="service-count badge bg-success" id="evangelizacao-list-count">0</span>
                </div>
                <div id="evangelizacao-list" class="service-list"></div>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="action-buttons">
        <button class="action-button btn btn-primary" onclick="openNewServiceModal()">
            <i class="bi bi-plus-lg"></i>
        </button>
    </div>

    <!-- Modal de Cadastro de Serviço -->
    <div class="modal fade" id="modalServico" tabindex="-1" aria-labelledby="modalServicoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalServicoLabel">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Agendar Serviço
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form id="formServico" class="needs-validation" novalidate>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="tipoServico" class="form-label">Tipo de Serviço</label>
                            <select class="form-select" id="tipoServico" required>
                                <option value="">Selecione o tipo de serviço</option>
                                <option value="BATISMOS">Batismos</option>
                                <option value="SANTAS_CEIAS">Santas Ceias</option>
                                <option value="REUNIAO_MOCIDADE">Reunião para Mocidade</option>
                                <option value="ENSAIOS_REGIONAIS">Ensaios Regionais</option>
                                <option value="ENSAIOS_LOCAIS">Ensaios Locais</option>
                                <option value="REUNIAO_CONSELHO">Reunião de Conselho</option>
                                <option value="OBRA_PIEDADE">Reunião da Piedade</option>
                                <option value="EVANGELIZACAO">Evangelização</option>
                            </select>
                            <div class="invalid-feedback">
                                Por favor, selecione o tipo de serviço.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="dataServico" class="form-label">Data</label>
                            <input type="date" class="form-control" id="dataServico" required>
                            <div class="invalid-feedback">
                                Por favor, selecione a data do serviço.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="localServico" class="form-label">Local</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="localServico" 
                                    placeholder="Selecione a congregação"
                                    required
                                    list="localidadesList"
                                    autocomplete="off">
                                <button class="btn btn-outline-primary" type="button" onclick="abrirModalLocalidades()"
                                    data-bs-toggle="tooltip" data-bs-placement="top" title="Buscar congregação">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <datalist id="localidadesList"></datalist>
                            <div class="invalid-feedback">
                                Por favor, selecione uma congregação.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="irmaoAtendente" class="form-label">Irmão que Atende</label>
                            <input type="text" class="form-control" id="irmaoAtendente" 
                                placeholder="Nome do irmão que atende" required>
                            <div class="invalid-feedback">
                                Por favor, informe o irmão que atende.
                            </div>
                        </div>

                        <div id="campoEncarregadoRegional" class="mb-3" style="display: none;">
                            <label for="encarregadoRegional" class="form-label">Encarregado Regional</label>
                            <input type="text" class="form-control" id="encarregadoRegional" 
                                placeholder="Nome do encarregado regional">
                            <div class="invalid-feedback">
                                Por favor, informe o encarregado regional.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="observacoesServico" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoesServico" rows="3" 
                                placeholder="Observações adicionais (opcional)"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Serviço -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesTitulo"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div id="detalhesConteudo"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="exportarRelatorio()">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Exportar Relatório
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Localidades -->
    <div class="modal fade" id="modalLocalidades" tabindex="-1" aria-labelledby="modalLocalidadesLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLocalidadesLabel">
                        <i class="bi bi-building me-2"></i>
                        Selecionar Congregação
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="buscaLocalidade" 
                            placeholder="Buscar por nome ou número"
                            oninput="filtrarLocalidades(this.value)">
                    </div>
                    <div id="listaLocalidades" class="list-group">
                        <!-- Será preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Service Modal -->
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceModalLabel">Novo Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="serviceForm">
                        <div class="mb-3">
                            <label for="serviceType" class="form-label">Tipo de Serviço</label>
                            <select class="form-select" id="serviceType" required>
                                <option value="">Selecione o tipo...</option>
                                <option value="BATISMOS">Batismos</option>
                                <option value="SANTAS_CEIAS">Santas Ceias</option>
                                <option value="REUNIAO_MOCIDADE">Reunião para Mocidade</option>
                                <option value="ENSAIOS_REGIONAIS">Ensaios Regionais</option>
                                <option value="ENSAIOS_LOCAIS">Ensaios Locais</option>
                                <option value="REUNIAO_CONSELHO">Reunião de Conselho</option>
                                <option value="OBRA_PIEDADE">Reunião da Piedade</option>
                                <option value="EVANGELIZACAO">Evangelização</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="serviceDate" class="form-label">Data</label>
                            <input type="date" class="form-control" id="serviceDate" required>
                        </div>

                        <div class="mb-3">
                            <label for="serviceCongregation" class="form-label">Congregação</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="serviceCongregation" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="openCongregationSearch()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="serviceAttendingBrother" class="form-label">Irmão Atendente</label>
                            <input type="text" class="form-control" id="serviceAttendingBrother" required>
                        </div>

                        <div id="regionalSupervisorField" class="mb-3" style="display: none;">
                            <label for="regionalSupervisor" class="form-label">Encarregado Regional</label>
                            <input type="text" class="form-control" id="regionalSupervisor">
                        </div>

                        <div class="mb-3">
                            <label for="serviceDetails" class="form-label">Observações</label>
                            <textarea class="form-control" id="serviceDetails" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveService()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Congregation Search Modal -->
    <div class="modal fade" id="congregationSearchModal" tabindex="-1" aria-labelledby="congregationSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="congregationSearchModalLabel">Buscar Congregação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="congregationSearchInput" placeholder="Digite o nome ou número...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchCongregations()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <div id="congregationSearchResults" class="list-group">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let modalServico;
        let modalLocalidades;
        let servicoAtual = null;

        // Initialize modals and form handlers
        document.addEventListener('DOMContentLoaded', () => {
            modalServico = new bootstrap.Modal(document.getElementById('modalServico'));
            modalLocalidades = new bootstrap.Modal(document.getElementById('modalLocalidades'));
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Handle service type change
            document.getElementById('tipoServico').addEventListener('change', (e) => {
                const campoEncarregadoRegional = document.getElementById('campoEncarregadoRegional');
                campoEncarregadoRegional.style.display = e.target.value === 'ENSAIOS_REGIONAIS' ? 'block' : 'none';
            });

            // Handle form submission
            document.getElementById('formServico').addEventListener('submit', (e) => {
                e.preventDefault();
                salvarServico();
            });

            // Handle congregation search input
            document.getElementById('buscaLocalidade').addEventListener('input', (e) => {
                filtrarLocalidades(e.target.value);
            });

            // Load congregations into datalist
            carregarCongregacoes();
        });

        // Load congregations
        function carregarCongregacoes() {
            const datalist = document.getElementById('localidadesList');
            congregationsRef.once('value')
                .then((snapshot) => {
                    datalist.innerHTML = '';
                    snapshot.forEach((child) => {
                        const congregation = child.val();
                        const option = document.createElement('option');
                        option.value = `${congregation.name} (${congregation.number})`;
                        datalist.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar congregações:', error);
                    showToast('Erro ao carregar congregações: ' + error.message, 'danger');
                });
        }

        // Open congregation search modal
        function abrirModalLocalidades() {
            const searchInput = document.getElementById('buscaLocalidade');
            searchInput.value = '';
            filtrarLocalidades('');
            modalLocalidades.show();
        }

        // Filter congregations
        function filtrarLocalidades(termo) {
            const listaLocalidades = document.getElementById('listaLocalidades');
            
            congregationsRef.orderByChild('name')
                .once('value')
                .then((snapshot) => {
                    listaLocalidades.innerHTML = '';
                    snapshot.forEach((child) => {
                        const congregation = child.val();
                        if (!termo || congregation.name.toLowerCase().includes(termo.toLowerCase()) || 
                            congregation.number.includes(termo)) {
                            const item = document.createElement('button');
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-building"></i>
                                        ${congregation.name}
                                    </div>
                                    <span class="badge bg-primary rounded-pill">${congregation.number}</span>
                                </div>
                            `;
                            item.onclick = () => selecionarLocalidade(congregation);
                            listaLocalidades.appendChild(item);
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao filtrar congregações:', error);
                    showToast('Erro ao filtrar congregações: ' + error.message, 'danger');
                });
        }

        // Select congregation
        function selecionarLocalidade(congregation) {
            document.getElementById('localServico').value = `${congregation.name} (${congregation.number})`;
            modalLocalidades.hide();
        }

        // Save service
        function salvarServico() {
            const form = document.getElementById('formServico');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const tipo = document.getElementById('tipoServico').value;
            const serviceData = {
                type: tipo,
                date: document.getElementById('dataServico').value,
                congregation: document.getElementById('localServico').value,
                attendingBrother: document.getElementById('irmaoAtendente').value,
                details: document.getElementById('observacoesServico').value || ''
            };

            if (tipo === 'ENSAIOS_REGIONAIS') {
                serviceData.regionalSupervisor = document.getElementById('encarregadoRegional').value;
            }

            const savePromise = servicoAtual
                ? updateService(servicoAtual, serviceData)
                : createService(serviceData);

            savePromise
                .then(() => {
                    showToast(servicoAtual ? 'Serviço atualizado com sucesso!' : 'Serviço cadastrado com sucesso!');
                    modalServico.hide();
                    form.reset();
                })
                .catch(error => {
                    showToast('Erro ao salvar serviço: ' + error.message, 'danger');
                });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast show bg-${type} text-white`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="toast-body">
                    ${message}
                </div>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            // Initial data load is handled by the Firebase listener
            initializeCalendar();
            initializeCongregations();
        });

        // Initialize congregations in Firebase
        function initializeCongregations() {
            const congregations = [
                { name: "Alvorada", number: "01" },
                { name: "Buritis", number: "02" },
                { name: "Capinópolis - Central", number: "03" },
                { name: "Cachoeira Dourada", number: "04" },
                { name: "Chaveslândia", number: "05" },
                { name: "Chico Mendes", number: "06" },
                { name: "Dom Alexandre", number: "07" },
                { name: "Eldorado", number: "08" },
                { name: "Flor de Minas", number: "09" },
                { name: "Gurinhatã", number: "10" },
                { name: "Ipiaçu", number: "11" },
                { name: "Ipiranga", number: "12" },
                { name: "Ituiutaba - Central", number: "13" },
                { name: "Jerônimo Mendonça", number: "14" },
                { name: "Marta Helena", number: "15" },
                { name: "Natal", number: "16" },
                { name: "Novo Tempo II", number: "17" },
                { name: "Recanto das Acácias", number: "18" },
                { name: "Santa Vitória - Central", number: "19" },
                { name: "Satélite Andradina", number: "20" },
                { name: "Setor Norte", number: "21" }
            ];

            // Check if congregations already exist
            congregationsRef.once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        // Create congregation entries
                        congregations.forEach(congregation => {
                            congregationsRef.push(congregation);
                        });
                        showToast('Congregações inicializadas com sucesso!', 'success');
                    }
                })
                .catch(error => {
                    console.error('Erro ao inicializar congregações:', error);
                    showToast('Erro ao inicializar congregações: ' + error.message, 'danger');
                });
        }

        // Open new service modal
        function openNewServiceModal() {
            servicoAtual = null;
            document.getElementById('modalServicoLabel').textContent = 'Novo Serviço';
            document.getElementById('formServico').reset();
            document.getElementById('campoEncarregadoRegional').style.display = 'none';
            modalServico.show();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
        // Modal instances
        let serviceModal;
        let congregationSearchModal;
        let currentServiceId = null;

        // Initialize modals
        document.addEventListener('DOMContentLoaded', () => {
            serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
            congregationSearchModal = new bootstrap.Modal(document.getElementById('congregationSearchModal'));
            
            // Show/hide regional supervisor field based on service type
            document.getElementById('serviceType').addEventListener('change', (e) => {
                const regionalSupervisorField = document.getElementById('regionalSupervisorField');
                regionalSupervisorField.style.display = e.target.value === 'ENSAIOS_REGIONAIS' ? 'block' : 'none';
            });
        });

        // Open new service modal
        function openNewServiceModal() {
            currentServiceId = null;
            document.getElementById('serviceModalLabel').textContent = 'Novo Serviço';
            document.getElementById('serviceForm').reset();
            serviceModal.show();
        }

        // Open congregation search modal
        function openCongregationSearch() {
            congregationSearchModal.show();
        }

        // Search congregations
        function searchCongregations() {
            const searchTerm = document.getElementById('congregationSearchInput').value;
            const resultsContainer = document.getElementById('congregationSearchResults');
            
            congregationsRef.orderByChild('name')
                .startAt(searchTerm)
                .endAt(searchTerm + '\uf8ff')
                .once('value')
                .then((snapshot) => {
                    resultsContainer.innerHTML = '';
                    snapshot.forEach((child) => {
                        const congregation = child.val();
                        const item = document.createElement('button');
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-building"></i>
                                    ${congregation.name}
                                </div>
                                <span class="badge bg-primary rounded-pill">${congregation.number}</span>
                            </div>
                        `;
                        item.onclick = () => selectCongregation(congregation);
                        resultsContainer.appendChild(item);
                    });
                });
        }

        // Select congregation from search results
        function selectCongregation(congregation) {
            document.getElementById('serviceCongregation').value = `${congregation.name} (${congregation.number})`;
            congregationSearchModal.hide();
        }

        // Save service
        function saveService() {
            const form = document.getElementById('serviceForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const serviceData = {
                type: document.getElementById('serviceType').value,
                date: document.getElementById('serviceDate').value,
                congregation: document.getElementById('serviceCongregation').value,
                attendingBrother: document.getElementById('serviceAttendingBrother').value,
                details: document.getElementById('serviceDetails').value
            };

            if (serviceData.type === 'ENSAIOS_REGIONAIS') {
                serviceData.regionalSupervisor = document.getElementById('regionalSupervisor').value;
            }

            if (currentServiceId) {
                updateService(currentServiceId, serviceData)
                    .then(() => {
                        showToast('Serviço atualizado com sucesso!');
                        serviceModal.hide();
                    })
                    .catch(error => {
                        showToast('Erro ao atualizar serviço: ' + error.message, 'danger');
                    });
            } else {
                createService(serviceData)
                    .then(() => {
                        showToast('Serviço cadastrado com sucesso!');
                        serviceModal.hide();
                    })
                    .catch(error => {
                        showToast('Erro ao cadastrar serviço: ' + error.message, 'danger');
                    });
            }
        }

        // Edit service
        function editService(serviceId) {
            currentServiceId = serviceId;
            document.getElementById('serviceModalLabel').textContent = 'Editar Serviço';
            
            servicesRef.child(serviceId).once('value')
                .then((snapshot) => {
                    const service = snapshot.val();
                    document.getElementById('serviceType').value = service.type;
                    document.getElementById('serviceDate').value = service.date;
                    document.getElementById('serviceCongregation').value = service.congregation;
                    document.getElementById('serviceAttendingBrother').value = service.attendingBrother;
                    document.getElementById('serviceDetails').value = service.details || '';
                    
                    const regionalSupervisorField = document.getElementById('regionalSupervisorField');
                    if (service.type === 'ENSAIOS_REGIONAIS') {
                        regionalSupervisorField.style.display = 'block';
                        document.getElementById('regionalSupervisor').value = service.regionalSupervisor || '';
                    } else {
                        regionalSupervisorField.style.display = 'none';
                    }
                    
                    serviceModal.show();
                });
        }

        // Confirm service deletion
        function confirmDeleteService(serviceId) {
            if (confirm('Tem certeza que deseja excluir este serviço?')) {
                deleteService(serviceId)
                    .then(() => {
                        showToast('Serviço excluído com sucesso!');
                    })
                    .catch(error => {
                        showToast('Erro ao excluir serviço: ' + error.message, 'danger');
                    });
            }
        }

        // Initialize calendar
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                eventClick: function(info) {
                    editService(info.event.id);
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    const start = fetchInfo.start.toISOString().split('T')[0];
                    const end = fetchInfo.end.toISOString().split('T')[0];
                    
                    getServicesByDateRange(start, end)
                        .then((snapshot) => {
                            const events = [];
                            snapshot.forEach((child) => {
                                const service = child.val();
                                events.push({
                                    id: child.key,
                                    title: `${SERVICE_TYPES[service.type].name} - ${service.congregation}`,
                                    start: service.date,
                                    backgroundColor: `var(--${SERVICE_TYPES[service.type].color}-color)`,
                                    borderColor: `var(--${SERVICE_TYPES[service.type].color}-color)`
                                });
                            });
                            successCallback(events);
                        })
                        .catch(failureCallback);
                }
            });

            calendar.render();
        }

        // Update service lists
        function updateServiceLists(services) {
            // Clear all lists first
            Object.keys(SERVICE_TYPES).forEach(type => {
                const listElement = document.getElementById(`${type.toLowerCase()}-list`);
                const countElement = document.getElementById(`${type.toLowerCase()}-list-count`);
                if (listElement) {
                    listElement.innerHTML = '';
                }
                if (countElement) {
                    countElement.textContent = '0';
                }
            });

            if (!services) return;

            // Sort services by date
            const sortedServices = Object.entries(services).sort((a, b) => {
                return new Date(a[1].date) - new Date(b[1].date);
            });

            // Group services by type
            const servicesByType = {};
            sortedServices.forEach(([id, service]) => {
                if (!servicesByType[service.type]) {
                    servicesByType[service.type] = [];
                }
                servicesByType[service.type].push([id, service]);
            });

            // Update each service type list
            Object.keys(SERVICE_TYPES).forEach(type => {
                const listId = `${type.toLowerCase()}-list`;
                const countId = `${type.toLowerCase()}-list-count`;
                const listElement = document.getElementById(listId);
                const countElement = document.getElementById(countId);
                const typeServices = servicesByType[type] || [];
                
                if (listElement) {
                    listElement.innerHTML = typeServices
                        .map(([id, service]) => createServiceCard(id, service))
                        .join('');
                }
                
                if (countElement) {
                    countElement.textContent = typeServices.length;
                }
            });
        }

        // Create service card HTML
        function createServiceCard(id, service) {
            const date = new Date(service.date).toLocaleDateString('pt-BR');
            const typeInfo = SERVICE_TYPES[service.type];
            
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-subtitle text-muted">
                                <i class="bi bi-calendar-event"></i> ${date}
                            </h6>
                            <span class="badge bg-${typeInfo.color}">
                                <i class="bi ${typeInfo.icon}"></i>
                            </span>
                        </div>
                        <p class="card-text">
                            <strong><i class="bi bi-building"></i> ${service.congregation}</strong><br>
                            <i class="bi bi-person"></i> ${service.attendingBrother}
                            ${service.regionalSupervisor ? `<br><i class="bi bi-person-badge"></i> ${service.regionalSupervisor}` : ''}
                            ${service.details ? `<br><small class="text-muted"><i class="bi bi-info-circle"></i> ${service.details}</small>` : ''}
                        </p>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editService('${id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteService('${id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Listen for service changes
        servicesRef.on('value', (snapshot) => {
            const services = snapshot.val();
            updateServiceLists(services);
            updateCalendar(services);
        });

        // Confirm service deletion
        function confirmDeleteService(serviceId) {
            if (confirm('Tem certeza que deseja excluir este serviço?')) {
                deleteService(serviceId)
                    .then(() => {
                        showToast('Serviço excluído com sucesso!');
                    })
                    .catch(error => {
                        showToast('Erro ao excluir serviço: ' + error.message, 'danger');
                    });
            }
        }
    </script>
</body>
</html>
